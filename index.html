<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>OoNooBet - Crash Game</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; text-align:center; }
    h1 { margin-top:30px; }
    #loginBox, #gameBox { margin-top:40px; }
    #balanceBox { margin:20px; font-size:20px; }
    #addPointsBtn {
      margin-left:10px; padding:3px 8px; background:#0a84ff; color:#fff;
      border:none; border-radius:5px; cursor:pointer;
    }
    #multiplier { font-size:50px; margin:20px; }
    input { padding:8px; border-radius:5px; border:none; margin:10px; }
    button {
      padding:10px 20px; margin:10px; border:none; border-radius:5px;
      background:#0a84ff; color:white; cursor:pointer;
    }
    button:hover { background:#0066cc; }
    #result { margin-top:20px; font-size:18px; }
    #leaderboard {
      margin-top:40px; background:#222; padding:20px; border-radius:10px;
      max-width:400px; margin-left:auto; margin-right:auto;
    }
    #leaderboard h2 { margin-bottom:15px; }
    #leaderboard ul { list-style:none; padding:0; }
    #leaderboard li {
      background:#333; padding:8px; margin:5px 0; border-radius:5px;
    }
  </style>
</head>
<body>
  <h1>🔥 OoNooBet - Crash Game 🔥</h1>

  <!-- تسجيل الدخول -->
  <div id="loginBox">
    <h2>تسجيل الدخول</h2>
    <input id="username" type="text" placeholder="اكتب اسمك">
    <button id="loginBtn">دخول</button>
  </div>

  <!-- اللعبة -->
  <div id="gameBox" style="display:none;">
    <div id="balanceBox">
      <span id="balance">رصيدك: 0</span>
      <button id="addPointsBtn">+</button>
    </div>

    <div id="game">
      <div id="multiplier">x1.00</div>
      <input id="bet" type="number" value="10" min="1"> نقاط<br>
      <button id="startBtn">ابدأ</button>
      <button id="cashoutBtn" disabled>اسحب</button>
      <div id="result"></div>
    </div>

    <div id="leaderboard">
      <h2>🏆 ترتيب اللاعبين</h2>
      <ul id="players"></ul>
    </div>
  </div>

<script>
let balance = 0;
let gameInterval = null;
let multiplier = 1.0;
let crashPoint = 0;
let playing = false;
let username = null;

// 🔗 رابط الـ API بتاع السيرفر Flask
const API_URL = "http://127.0.0.1:5000"; // غيّره للرابط اللي هترفع عليه الباك-إند

// جلب الرصيد من السيرفر
async function fetchBalance() {
  const res = await fetch(`${API_URL}/balance?user=${username}`);
  const data = await res.json();
  balance = data.balance;
  document.getElementById("balance").innerText = "رصيدك: " + balance;
}

// تحديث الرصيد محلي بعد اللعبة
async function updateBalanceLocally(amount) {
  balance += amount;
  document.getElementById("balance").innerText = "رصيدك: " + balance;

  // إرسال التحديث للسيرفر
  await fetch(`${API_URL}/update`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: username, amount: amount })
  });
}

// بدء اللعبة
function startGame() {
  let bet = parseInt(document.getElementById("bet").value);
  if (balance <= 0) {
    alert("⚠️ لازم تطلب نقاط من الأدمن الأول");
    return;
  }
  if (bet > balance || bet <= 0) {
    alert("⚠️ رصيدك مش كافي أو الرهان غير صحيح");
    return;
  }

  playing = true;
  multiplier = 1.0;
  crashPoint = (Math.random() * 4 + 1.3).toFixed(2);
  document.getElementById("result").innerText = "";
  document.getElementById("cashoutBtn").disabled = false;

  // خصم الرهان من الرصيد
  updateBalanceLocally(-bet);

  gameInterval = setInterval(() => {
    multiplier = (parseFloat(multiplier) + 0.1).toFixed(2);
    document.getElementById("multiplier").innerText = "x" + multiplier;

    if (parseFloat(multiplier) >= crashPoint) {
      clearInterval(gameInterval);
      playing = false;
      document.getElementById("result").innerText =
        "❌ كراش عند x" + crashPoint + " - خسرت";
      document.getElementById("cashoutBtn").disabled = true;
    }
  }, 500);
}

// السحب
function cashOut() {
  if (!playing) return;
  clearInterval(gameInterval);
  playing = false;

  let bet = parseInt(document.getElementById("bet").value);
  let win = Math.floor(bet * multiplier);

  updateBalanceLocally(win);

  document.getElementById("result").innerText =
    "✅ سحبت عند x" + multiplier + " - كسبت " + win;
  document.getElementById("cashoutBtn").disabled = true;
}

// زرار الأدمن
document.getElementById("addPointsBtn").onclick = () => {
  window.open("https://t.me/OoNooBet", "_blank");
};

// تسجيل الدخول
document.getElementById("loginBtn").onclick = async () => {
  const inputName = document.getElementById("username").value.trim();
  if (!inputName) {
    alert("⚠️ لازم تكتب اسمك");
    return;
  }
  username = inputName;

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("gameBox").style.display = "block";

  await fetchBalance();
  loadLeaderboard();
};

// تحديث الترتيب (مؤقت)
async function loadLeaderboard() {
  const players = document.getElementById("players");
  players.innerHTML = `
    <li>${username} - ${balance} نقطة</li>
    <li>Ahmed - 250 نقطة</li>
    <li>Ali - 180 نقطة</li>
    <li>Mohamed - 120 نقطة</li>
  `;
}

document.getElementById("startBtn").onclick = startGame;
document.getElementById("cashoutBtn").onclick = cashOut;
</script>
</body>
</html>
